# ============================================================================
# OpenOCD Configuration for Altera MAX V CPLD Programming
# Via Raspberry Pi GPIO JTAG
# ============================================================================

# Use Raspberry Pi GPIO as JTAG interface
interface bcm2835gpio

# Raspberry Pi 4 peripheral base address
bcm2835gpio_peripheral_base 0xFE000000

# GPIO Pin Mapping for JTAG
# Format: TMS TCK TDO TDI
bcm2835gpio_jtag_nums 22 25 24 23

# JTAG adapter speed (1 MHz)
adapter_khz 1000

# Define MAX V CPLD TAP
# MAX V 5M80Z expected ID: 0x020a10dd
jtag newtap maxv tap -irlen 10 -expected-id 0x020a10dd

# Initialize JTAG chain
init

# Display JTAG chain
echo "Scanning JTAG chain..."
scan_chain

# Program the CPLD using SVF file
# SVF file should be at /tmp/cpld.svf
echo "Programming CPLD from SVF file..."
svf /tmp/cpld.svf progress

# Verify
echo "Programming complete!"
echo "Verify by testing SPI communication"

# Shutdown OpenOCD
shutdown
