# ============================================================================
# OpenOCD Configuration for Altera MAX V CPLD Programming
# Via Raspberry Pi GPIO JTAG
# Updated for Linux Kernel 6.12+ (gpiochip512)
# ============================================================================

# Use Raspberry Pi GPIO as JTAG interface (native BCM driver)
interface bcm2835gpio

# Raspberry Pi 4/5 peripheral base address
# Note: Kernel 6.1+ may use different mapping, auto-detection usually works
bcm2835gpio_peripheral_base 0xFE000000

# GPIO Speed (khz)
adapter speed 1000

# GPIO Pin Mapping for JTAG (BCM numbering)
# Format: TMS TCK TDO TDI
bcm2835gpio_jtag_nums 22 25 24 23

# JTAG Transport
transport select jtag

# Define MAX V CPLD TAP
# MAX V 5M80Z expected ID: 0x020a10dd
# IR length: 10 bits
jtag newtap maxv tap -irlen 10 -expected-id 0x020a10dd

# Initialize JTAG chain
init

# Display JTAG chain
echo "========================================"
echo "Scanning JTAG chain..."
echo "========================================"
scan_chain

# Program the CPLD using SVF file
echo ""
echo "========================================"
echo "Programming CPLD from SVF file..."
echo "========================================"
svf /tmp/cpld.svf progress

echo ""
echo "========================================"
echo "Programming Complete!"
echo "========================================"

# Shutdown OpenOCD
shutdown
